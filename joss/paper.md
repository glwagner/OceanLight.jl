---
title: "OceanLight.jl: Monte Carlo simulation to calculate downwelling irradiance"
tags:
  - Julia
  - Ocean
  - Light
  - Monte Carlo 
  - Simulation
authors:
  - name: Pacharadech Wacharanan
    orcid: 0009-0004-4029-782X
    affiliation: 2
  - name: Xuanting Hao
    orcid: 0000-0003-4898-1074
    affiliation: "1, 2" 
affiliations:
 - name: Scripps Institution of Oceanography, University of California San Diego, United States
   index: 1
 - name: Department of Mechanical and Aerospace Engineering, University of California San Diego, United States
   index: 2  
date: 1 Febuary 2025
bibliography: paper.bib

---

# Summary

`OceanLight` is a Julia-based scientific package that simulates photon trajectories and stores their downward irradiance field in three-dimensional space using direct Monte Carlo time-independent simulation. The simulated photon trajectories begin in the air phase, interact with the water surface, refract and transfer into water, then travel, and scatter until they are either absorbed or reach the bottom of the field of interest. `OceanLight` automates the entire procedure of a photon's sequence of events, including determining its fate and storing its landing position, which can later be exported and accessed in `.h5` format.

# Statement of need

Optical Oceanography concerns all aspects of light and its interaction with seawater. This field is crucial for addressing problems related to physical, biological, and chemical oceanographic processes, such as phytoplankton photosynthesis, biogeochemical cycles, and the recent rapid climate change [@Dickey:2011;@Dickey:2006]. However, due to the complex interaction between light and free surface wave geometry, the irradiance distribution can be highly fluctuating [@Darecki:2011;@Gernez:2011], making it difficult to obtain analytical solutions.

One of the prominent numerical methods is the implementation of the Monte Carlo (MC) method to approximate the light field. The general idea is to construct probability distributions of entire photon trajectories by repeatedly sampling random paths, including scattering, absorption, and path lengths. Despite its generality, this method has proven to be powerful [@Mobley:1994]. The MC method has been widely applied to various specific problems related to the calculation of downward irradiance field — for instance, the Monte Carlo radiative transfer solver accounting for shadowing effect and detector size [@Xu:2014] or Direct Monte Carlo simulation of both polarized and unpolarized light [@Xu:2011].   

Here, we introduce `OceanLight`, a Julia-based software package designed to facilitate three-dimensional, time-independent, direct Monte Carlo simulation of light fields in seawater. `OceanLight` is based on the Forward Monte Carlo Methods as described by @Mobley:1994. It includes the extension of light refraction at the air-water interfaces, where the refracted angle in the water phase is governed by Snell's Law, and the proportion of transmitted light is determined by Fresnel equations. The probability distribution of scattering polar angles is based on measurements reported by Petzold(1972) [@Kirk:1981]. Additionally, `OceanLight` supports parallel computing to enhance performance and reduce computational time. The downwelling irradiance fields generated by `OceanLight` also serves as a valueable resource for machine learning applications — enabling the development of accelerated models that require less computational cost, though their accuracy remains strongly dependent on the quantity and quality of training data. Since its development, `OceanLight` has been used to generating training dataset for deep neural network and to validate their results [@Hao:2022]. 

# Main Features

The main features of ‘OceanLight’ are illustrated in figure 2.

![Flow Diagram of the OceanLight's main feature.\label{fig:}](Flow_diagramver3.png)

`OceanLight` requires user input in three categories.

1. **Irradiance:** resolution of the solution grid, attenuation coefficients, and boundary condition specification 
2. **Photon:** number of Photons and grid spacing
3. **Wave:** surface elevation and related attributes 

`OceanLight` reads input data from `.yml` files and stores it in Julia's `struct` format. In addition, surface wave attributes—comprising surface elevation and its partial derivatives in the x and y directions—are required.  Users may either generate randomized surface elevations using `OceanLight.setwave!` or import their own data and convert it to align with the photon entry grid using `OceanLight.convertwave!`.

At the air–water interface, `OceanLight.interface` calculates the polar angle $\theta$ and azimuthal angle $\phi$ at which photons are transmitted into the water, using Snell’s Law. The ratio of transmitted to reflected photons is determined using the Fresnel equations.

Once photons are transmitted into the water, `OceanLight.transfer` simulates their paths using the direct Monte Carlo method. Each photon is traced as it travels through the domain, with its position updated after every scattering or absorption event. The process continues until the photon is either absorbed or reaches the bottom boundary.To accelerate computation, `OceanLight`supports parallel processing via OpenMPI, distributing photons evenly across CPU threads. Upon completion, the results are gathered and combined to reconstruct the irradiance field.

Simulation output can be exported in `.h5` format using `OceanLight.exported`, allowing users access to the full three-dimensional irradiance field and its statistical properties.

To demonstrate the capabilities of this package, we simulate downwelling irradiance in two scenarios:

* *Flat water surface:* $\left( \eta_{x} = \eta_{y} = 0  \right)$ with light intensity focused at the center of a spatial domain $x,y \in [\mathrm{−10m},\mathrm{10m}]$, using $10^{8}$ photons concentrated at a single point.

* *Realistic surface geometry:* based on observed surface elevation, with light intensity evenly distributed across the domain $x,y \in [\mathrm{−40m},\mathrm{40m}]$, using $10^{3}$ photons at every grid points.

In both cases, the optical properties of water are identical, with an absorption coefficient $a = 0.0196$ and a scattering coefficient $b = 0.0031$, representing seawater attenuation at a wavelength of $490 \mathrm{nm}$ [Smith:1981]. The spatial grid size in both x and y directions is chosen to ensure that the lowest wave numbers captured during the computation of surface elevation derivatives correspond to `pex` and `pey`. The irradiance field is stored on a grid of $512 \times 512 \times 190$ points, spanning a depth domain of $z \in [\mathrm{−190m},\mathrm{10m}]$. TPeriodic boundary conditions are applied on all sides. 

![Simulation of $10^{8}$ photons at the center of a flat surface. (a) Irradiance field on the horizontal plane at $30\ \mathrm{m}$ depth. (b) Irradiance field on the horizontal plane at $150\ \mathrm{m}$ depth. (c) Irradiance field on the vertical plane at the center. \label{fig:}](Center1e8.png)

In the flat surface case, most photons are transmitted nearly perpendicular to the surface, as determined by the Fresnel equations. In the second scenario, we simulate a more realistic case using imported surface elevation data and uniformly distributed light input. The spatial spacing of incoming photons matches the `dx` and `dy` values used in the simulation grid.

![Simulation of 1000 Photons at each grid point with observed surface elevation. (a) Irradiance field on the horizontal plane at $30\ \mathrm{m}$ depth. (b) Irradiance field on the horizontal plane at $150\ \mathrm{m}$ depth. (c) Irradiance field on the vertical plane at the center. \label{fig:}](Wholegrid1000.png)

# Acknowledgement 

Xuanting Hao contributed to the code implementation and numerical modeling. Pacharadech Wacharanan contributed to the organization and documentation of the numerical solver. The authors would like to thank Sai Pramod Anumula and Yifeng Mao for their valuable feedback and comments on this project. 

# References

